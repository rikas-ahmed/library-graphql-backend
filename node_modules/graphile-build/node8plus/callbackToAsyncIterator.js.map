{"version":3,"file":"callbackToAsyncIterator.js","names":["_iterall","require","defaultOnError","err","callbackToAsyncIterator","listener","options","onError","buffering","onClose","pullQueue","pushQueue","listening","listenerReturnValue","pushValue","value","length","shift","done","push","pullValue","Promise","resolve","emptyQueue","forEach","undefined","then","a","catch","next","return","throw","error","reject","$$asyncIterator"],"sources":["../src/callbackToAsyncIterator.js"],"sourcesContent":["// @flow\n/* eslint-disable flowtype/no-weak-types */\n// Turn a callback-based listener into an async iterator\n// From https://raw.githubusercontent.com/withspectrum/callback-to-async-iterator/master/src/index.js\n// License MIT (Copyright (c) 2017 Maximilian Stoiber)\n// Based on https://github.com/apollographql/graphql-subscriptions/blob/master/src/event-emitter-to-async-iterator.ts\nimport { $$asyncIterator } from \"iterall\";\n\nconst defaultOnError = (err: Error) => {\n  throw err;\n};\n\nexport default function callbackToAsyncIterator<\n  CallbackInput: any,\n  ReturnVal: any\n>(\n  listener: ((arg: CallbackInput) => any) => ?ReturnVal | Promise<?ReturnVal>,\n  options?: {\n    onError?: (err: Error) => void,\n    onClose?: (arg?: ?ReturnVal) => void,\n    buffering?: boolean,\n  } = {}\n) {\n  const { onError = defaultOnError, buffering = true, onClose } = options;\n  let pullQueue = [];\n  let pushQueue = [];\n  let listening = true;\n  let listenerReturnValue;\n\n  function pushValue(value) {\n    if (pullQueue.length !== 0) {\n      pullQueue.shift()({ value, done: false });\n    } else if (buffering === true) {\n      pushQueue.push(value);\n    }\n  }\n\n  function pullValue() {\n    return new Promise(resolve => {\n      if (pushQueue.length !== 0) {\n        resolve({ value: pushQueue.shift(), done: false });\n      } else {\n        pullQueue.push(resolve);\n      }\n    });\n  }\n\n  function emptyQueue() {\n    if (listening) {\n      listening = false;\n      pullQueue.forEach(resolve => resolve({ value: undefined, done: true }));\n      pullQueue = [];\n      pushQueue = [];\n      onClose && onClose(listenerReturnValue);\n    }\n  }\n\n  try {\n    // Start listener\n    Promise.resolve(listener(value => pushValue(value)))\n      .then(a => {\n        listenerReturnValue = a;\n      })\n      .catch(err => {\n        onError(err);\n      });\n\n    return {\n      next(): Promise<{ value?: CallbackInput, done: boolean }> {\n        return listening ? pullValue() : this.return();\n      },\n      return(): Promise<{ value: typeof undefined, done: boolean }> {\n        emptyQueue();\n        return Promise.resolve({ value: undefined, done: true });\n      },\n      throw(error: Error) {\n        emptyQueue();\n        onError(error);\n        return Promise.reject(error);\n      },\n      [$$asyncIterator]() {\n        return this;\n      },\n    };\n  } catch (err) {\n    onError(err);\n    return {\n      next() {\n        return Promise.reject(err);\n      },\n      return() {\n        return Promise.reject(err);\n      },\n      throw(error: Error) {\n        return Promise.reject(error);\n      },\n      [$$asyncIterator]() {\n        return this;\n      },\n    };\n  }\n}\n"],"mappings":"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"}