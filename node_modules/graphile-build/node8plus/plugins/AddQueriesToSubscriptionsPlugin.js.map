{"version":3,"file":"AddQueriesToSubscriptionsPlugin.js","names":["AddQueriesToSubscriptionsPlugin","builder","subscriptions","live","hook","fields","build","context","extend","getTypeByName","inflection","scope","isRootSubscription","fieldWithHooks","Query","builtin","queryFields","getFields","subscriptionFields","Object","keys","reduce","memo","queryFieldName","queryField","oldResolve","resolve","description","type","args","newArgs","arg","name","defaultValue","e","info","rootValue","liveAbort","subscribe","liveCoordinator","deprecationReason","isDeprecated","undefined","isLiveField","originalField","_default","exports","default"],"sources":["../../src/plugins/AddQueriesToSubscriptionsPlugin.js"],"sourcesContent":["// @flow\nimport type { Plugin } from \"../SchemaBuilder\";\nimport type { GraphQLObjectType } from \"graphql\";\n\nconst AddQueriesToSubscriptionsPlugin: Plugin = function (\n  builder,\n  { subscriptions, live }\n) {\n  if (!subscriptions || !live) {\n    return;\n  }\n  builder.hook(\n    \"GraphQLObjectType:fields\",\n    (fields, build, context) => {\n      const { extend, getTypeByName, inflection } = build;\n      const {\n        scope: { isRootSubscription },\n        fieldWithHooks,\n      } = context;\n      if (!isRootSubscription) {\n        return fields;\n      }\n\n      const Query: GraphQLObjectType = getTypeByName(\n        inflection.builtin(\"Query\")\n      );\n      const queryFields = Query.getFields();\n      const subscriptionFields = Object.keys(queryFields).reduce(\n        (memo, queryFieldName) => {\n          const queryField = queryFields[queryFieldName];\n          const oldResolve = queryField.resolve;\n          memo[queryFieldName] = fieldWithHooks(\n            inflection.live(queryFieldName),\n            {\n              description: (queryField.description || \"\") + \" (live)\",\n              type: queryField.type,\n              args: (queryField.args || []).reduce((newArgs, arg) => {\n                const { name, description, type, defaultValue } = arg;\n                newArgs[name] = {\n                  description,\n                  type,\n                  defaultValue,\n                };\n                return newArgs;\n              }, {}),\n              ...(oldResolve\n                ? {\n                    resolve: async (...args) => {\n                      try {\n                        return await oldResolve(...args);\n                      } catch (e) {\n                        const info = args[3];\n                        if (\n                          info.rootValue &&\n                          typeof info.rootValue.liveAbort === \"function\"\n                        ) {\n                          info.rootValue.liveAbort(e);\n                        }\n                        throw e;\n                      }\n                    },\n                  }\n                : null),\n              subscribe: build.liveCoordinator.subscribe,\n              deprecationReason: queryField.isDeprecated\n                ? queryField.deprecationReason\n                : undefined,\n            },\n            {\n              isLiveField: true,\n              originalField: queryField,\n            }\n          );\n          return memo;\n        },\n        {}\n      );\n      return extend(fields, subscriptionFields);\n    },\n    [\"AddQueriesToSubscriptions\"]\n  );\n};\nexport default AddQueriesToSubscriptionsPlugin;\n"],"mappings":";;;;;;AAIA,MAAMA,+BAAuC,GAAG,SAAAA,CAC9CC,OAAO,EACP;EAAEC,aAAa;EAAEC;AAAK,CAAC,EACvB;EACA,IAAI,CAACD,aAAa,IAAI,CAACC,IAAI,EAAE;IAC3B;EACF;EACAF,OAAO,CAACG,IAAI,CACV,0BAA0B,EAC1B,CAACC,MAAM,EAAEC,KAAK,EAAEC,OAAO,KAAK;IAC1B,MAAM;MAAEC,MAAM;MAAEC,aAAa;MAAEC;IAAW,CAAC,GAAGJ,KAAK;IACnD,MAAM;MACJK,KAAK,EAAE;QAAEC;MAAmB,CAAC;MAC7BC;IACF,CAAC,GAAGN,OAAO;IACX,IAAI,CAACK,kBAAkB,EAAE;MACvB,OAAOP,MAAM;IACf;IAEA,MAAMS,KAAwB,GAAGL,aAAa,CAC5CC,UAAU,CAACK,OAAO,CAAC,OAAO,CAC5B,CAAC;IACD,MAAMC,WAAW,GAAGF,KAAK,CAACG,SAAS,CAAC,CAAC;IACrC,MAAMC,kBAAkB,GAAGC,MAAM,CAACC,IAAI,CAACJ,WAAW,CAAC,CAACK,MAAM,CACxD,CAACC,IAAI,EAAEC,cAAc,KAAK;MACxB,MAAMC,UAAU,GAAGR,WAAW,CAACO,cAAc,CAAC;MAC9C,MAAME,UAAU,GAAGD,UAAU,CAACE,OAAO;MACrCJ,IAAI,CAACC,cAAc,CAAC,GAAGV,cAAc,CACnCH,UAAU,CAACP,IAAI,CAACoB,cAAc,CAAC,EAC/B;QACEI,WAAW,EAAE,CAACH,UAAU,CAACG,WAAW,IAAI,EAAE,IAAI,SAAS;QACvDC,IAAI,EAAEJ,UAAU,CAACI,IAAI;QACrBC,IAAI,EAAE,CAACL,UAAU,CAACK,IAAI,IAAI,EAAE,EAAER,MAAM,CAAC,CAACS,OAAO,EAAEC,GAAG,KAAK;UACrD,MAAM;YAAEC,IAAI;YAAEL,WAAW;YAAEC,IAAI;YAAEK;UAAa,CAAC,GAAGF,GAAG;UACrDD,OAAO,CAACE,IAAI,CAAC,GAAG;YACdL,WAAW;YACXC,IAAI;YACJK;UACF,CAAC;UACD,OAAOH,OAAO;QAChB,CAAC,EAAE,CAAC,CAAC,CAAC;QACN,IAAIL,UAAU,GACV;UACEC,OAAO,EAAE,MAAAA,CAAO,GAAGG,IAAI,KAAK;YAC1B,IAAI;cACF,OAAO,MAAMJ,UAAU,CAAC,GAAGI,IAAI,CAAC;YAClC,CAAC,CAAC,OAAOK,CAAC,EAAE;cACV,MAAMC,IAAI,GAAGN,IAAI,CAAC,CAAC,CAAC;cACpB,IACEM,IAAI,CAACC,SAAS,IACd,OAAOD,IAAI,CAACC,SAAS,CAACC,SAAS,KAAK,UAAU,EAC9C;gBACAF,IAAI,CAACC,SAAS,CAACC,SAAS,CAACH,CAAC,CAAC;cAC7B;cACA,MAAMA,CAAC;YACT;UACF;QACF,CAAC,GACD,IAAI,CAAC;QACTI,SAAS,EAAEhC,KAAK,CAACiC,eAAe,CAACD,SAAS;QAC1CE,iBAAiB,EAAEhB,UAAU,CAACiB,YAAY,GACtCjB,UAAU,CAACgB,iBAAiB,GAC5BE;MACN,CAAC,EACD;QACEC,WAAW,EAAE,IAAI;QACjBC,aAAa,EAAEpB;MACjB,CACF,CAAC;MACD,OAAOF,IAAI;IACb,CAAC,EACD,CAAC,CACH,CAAC;IACD,OAAOd,MAAM,CAACH,MAAM,EAAEa,kBAAkB,CAAC;EAC3C,CAAC,EACD,CAAC,2BAA2B,CAC9B,CAAC;AACH,CAAC;AAAC,IAAA2B,QAAA,GACa7C,+BAA+B;AAAA8C,OAAA,CAAAC,OAAA,GAAAF,QAAA"}