{"version":3,"file":"withPgClient.js","names":["_pg","_interopRequireDefault","require","_debug","obj","__esModule","default","debug","debugFactory","constructorName","constructor","name","quacksLikePgClient","pgConfig","connect","end","escapeLiteral","escapeIdentifier","quacksLikePgPool","Client","options","query","getPgClientAndReleaserFromConfig","process","env","DATABASE_URL","releasePgClient","pgClient","pg","release","Error","Pool","pgPool","undefined","on","e","Promise","resolve","reject","err","exports","withPgClient","fn","errorHandler","console","error","message","removeListener","_default"],"sources":["../src/withPgClient.js"],"sourcesContent":["// @flow\nimport pg from \"pg\";\nimport debugFactory from \"debug\";\n\nconst debug = debugFactory(\"graphile-build-pg\");\n\nfunction constructorName(obj) {\n  return obj && typeof obj.constructor === \"function\" && obj.constructor.name;\n}\n\n// Some duck-typing\n\nfunction quacksLikePgClient(pgConfig: mixed): boolean {\n  // A diagnosis of exclusion\n  if (!pgConfig || typeof pgConfig !== \"object\") return false;\n  if (constructorName(pgConfig) !== \"Client\") return false;\n  if (typeof pgConfig.connect !== \"function\") return false;\n  if (typeof pgConfig.end !== \"function\") return false;\n  if (typeof pgConfig.escapeLiteral !== \"function\") return false;\n  if (typeof pgConfig.escapeIdentifier !== \"function\") return false;\n  return true;\n}\n\nexport function quacksLikePgPool(pgConfig: mixed): boolean {\n  // A diagnosis of exclusion\n  if (!pgConfig || typeof pgConfig !== \"object\") return false;\n  if (\n    constructorName(pgConfig) !== \"Pool\" &&\n    constructorName(pgConfig) !== \"BoundPool\"\n  ) {\n    return false;\n  }\n  if (!pgConfig.Client) return false;\n  if (!pgConfig.options) return false;\n  if (typeof pgConfig.connect !== \"function\") return false;\n  if (typeof pgConfig.end !== \"function\") return false;\n  if (typeof pgConfig.query !== \"function\") return false;\n  return true;\n}\n\nexport const getPgClientAndReleaserFromConfig = async (\n  pgConfig: pg.Client | pg.Pool | string = process.env.DATABASE_URL\n) => {\n  let releasePgClient = () => {};\n  let pgClient: pg.Client;\n  if (pgConfig instanceof pg.Client || quacksLikePgClient(pgConfig)) {\n    pgClient = (pgConfig: pg.Client);\n    if (!pgClient.release) {\n      throw new Error(\n        \"We only support PG clients from a PG pool (because otherwise the `await` call can hang indefinitely if an error occurs and there's no error handler)\"\n      );\n    }\n  } else if (pgConfig instanceof pg.Pool || quacksLikePgPool(pgConfig)) {\n    const pgPool = (pgConfig: pg.Pool);\n    pgClient = await pgPool.connect();\n    releasePgClient = () => pgClient.release();\n  } else if (pgConfig === undefined || typeof pgConfig === \"string\") {\n    pgClient = new pg.Client(pgConfig);\n    pgClient.on(\"error\", e => {\n      debug(\"pgClient error occurred: %s\", e);\n    });\n    releasePgClient = () =>\n      new Promise<void>((resolve, reject) =>\n        pgClient.end(err => (err ? reject(err) : resolve()))\n      );\n    await new Promise((resolve, reject) =>\n      pgClient.connect(err => (err ? reject(err) : resolve()))\n    );\n  } else {\n    throw new Error(\n      \"You must provide either a pg.Pool or pg.Client instance or a PostgreSQL connection string.\"\n    );\n  }\n  return { pgClient, releasePgClient };\n};\n\nconst withPgClient = async (\n  pgConfig: pg.Client | pg.Pool | string | void,\n  fn: (pgClient: pg.Client) => *\n) => {\n  if (!fn) {\n    throw new Error(\"Nothing to do!\");\n  }\n  const { pgClient, releasePgClient } = await getPgClientAndReleaserFromConfig(\n    pgConfig\n  );\n  const errorHandler = e => {\n    // eslint-disable-next-line no-console\n    console.error(\"withPgClient client error:\", e.message);\n  };\n  pgClient.on(\"error\", errorHandler);\n  try {\n    return await fn(pgClient);\n  } finally {\n    pgClient.removeListener(\"error\", errorHandler);\n    try {\n      await releasePgClient();\n    } catch (e) {\n      // Failed to release, assuming success\n    }\n  }\n};\n\nexport default withPgClient;\n"],"mappings":";;;;;;;AACA,IAAAA,GAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,MAAA,GAAAF,sBAAA,CAAAC,OAAA;AAAiC,SAAAD,uBAAAG,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAEjC,MAAMG,KAAK,GAAG,IAAAC,cAAY,EAAC,mBAAmB,CAAC;AAE/C,SAASC,eAAeA,CAACL,GAAG,EAAE;EAC5B,OAAOA,GAAG,IAAI,OAAOA,GAAG,CAACM,WAAW,KAAK,UAAU,IAAIN,GAAG,CAACM,WAAW,CAACC,IAAI;AAC7E;;AAEA;;AAEA,SAASC,kBAAkBA,CAACC,QAAe,EAAW;EACpD;EACA,IAAI,CAACA,QAAQ,IAAI,OAAOA,QAAQ,KAAK,QAAQ,EAAE,OAAO,KAAK;EAC3D,IAAIJ,eAAe,CAACI,QAAQ,CAAC,KAAK,QAAQ,EAAE,OAAO,KAAK;EACxD,IAAI,OAAOA,QAAQ,CAACC,OAAO,KAAK,UAAU,EAAE,OAAO,KAAK;EACxD,IAAI,OAAOD,QAAQ,CAACE,GAAG,KAAK,UAAU,EAAE,OAAO,KAAK;EACpD,IAAI,OAAOF,QAAQ,CAACG,aAAa,KAAK,UAAU,EAAE,OAAO,KAAK;EAC9D,IAAI,OAAOH,QAAQ,CAACI,gBAAgB,KAAK,UAAU,EAAE,OAAO,KAAK;EACjE,OAAO,IAAI;AACb;AAEO,SAASC,gBAAgBA,CAACL,QAAe,EAAW;EACzD;EACA,IAAI,CAACA,QAAQ,IAAI,OAAOA,QAAQ,KAAK,QAAQ,EAAE,OAAO,KAAK;EAC3D,IACEJ,eAAe,CAACI,QAAQ,CAAC,KAAK,MAAM,IACpCJ,eAAe,CAACI,QAAQ,CAAC,KAAK,WAAW,EACzC;IACA,OAAO,KAAK;EACd;EACA,IAAI,CAACA,QAAQ,CAACM,MAAM,EAAE,OAAO,KAAK;EAClC,IAAI,CAACN,QAAQ,CAACO,OAAO,EAAE,OAAO,KAAK;EACnC,IAAI,OAAOP,QAAQ,CAACC,OAAO,KAAK,UAAU,EAAE,OAAO,KAAK;EACxD,IAAI,OAAOD,QAAQ,CAACE,GAAG,KAAK,UAAU,EAAE,OAAO,KAAK;EACpD,IAAI,OAAOF,QAAQ,CAACQ,KAAK,KAAK,UAAU,EAAE,OAAO,KAAK;EACtD,OAAO,IAAI;AACb;AAEO,MAAMC,gCAAgC,GAAG,MAAAA,CAC9CT,QAAsC,GAAGU,OAAO,CAACC,GAAG,CAACC,YAAY,KAC9D;EACH,IAAIC,eAAe,GAAGA,CAAA,KAAM,CAAC,CAAC;EAC9B,IAAIC,QAAmB;EACvB,IAAId,QAAQ,YAAYe,WAAE,CAACT,MAAM,IAAIP,kBAAkB,CAACC,QAAQ,CAAC,EAAE;IACjEc,QAAQ,GAAId,QAAoB;IAChC,IAAI,CAACc,QAAQ,CAACE,OAAO,EAAE;MACrB,MAAM,IAAIC,KAAK,CACb,sJACF,CAAC;IACH;EACF,CAAC,MAAM,IAAIjB,QAAQ,YAAYe,WAAE,CAACG,IAAI,IAAIb,gBAAgB,CAACL,QAAQ,CAAC,EAAE;IACpE,MAAMmB,MAAM,GAAInB,QAAkB;IAClCc,QAAQ,GAAG,MAAMK,MAAM,CAAClB,OAAO,CAAC,CAAC;IACjCY,eAAe,GAAGA,CAAA,KAAMC,QAAQ,CAACE,OAAO,CAAC,CAAC;EAC5C,CAAC,MAAM,IAAIhB,QAAQ,KAAKoB,SAAS,IAAI,OAAOpB,QAAQ,KAAK,QAAQ,EAAE;IACjEc,QAAQ,GAAG,IAAIC,WAAE,CAACT,MAAM,CAACN,QAAQ,CAAC;IAClCc,QAAQ,CAACO,EAAE,CAAC,OAAO,EAAEC,CAAC,IAAI;MACxB5B,KAAK,CAAC,6BAA6B,EAAE4B,CAAC,CAAC;IACzC,CAAC,CAAC;IACFT,eAAe,GAAGA,CAAA,KAChB,IAAIU,OAAO,CAAO,CAACC,OAAO,EAAEC,MAAM,KAChCX,QAAQ,CAACZ,GAAG,CAACwB,GAAG,IAAKA,GAAG,GAAGD,MAAM,CAACC,GAAG,CAAC,GAAGF,OAAO,CAAC,CAAE,CACrD,CAAC;IACH,MAAM,IAAID,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAChCX,QAAQ,CAACb,OAAO,CAACyB,GAAG,IAAKA,GAAG,GAAGD,MAAM,CAACC,GAAG,CAAC,GAAGF,OAAO,CAAC,CAAE,CACzD,CAAC;EACH,CAAC,MAAM;IACL,MAAM,IAAIP,KAAK,CACb,4FACF,CAAC;EACH;EACA,OAAO;IAAEH,QAAQ;IAAED;EAAgB,CAAC;AACtC,CAAC;AAACc,OAAA,CAAAlB,gCAAA,GAAAA,gCAAA;AAEF,MAAMmB,YAAY,GAAG,MAAAA,CACnB5B,QAA6C,EAC7C6B,EAA8B,KAC3B;EACH,IAAI,CAACA,EAAE,EAAE;IACP,MAAM,IAAIZ,KAAK,CAAC,gBAAgB,CAAC;EACnC;EACA,MAAM;IAAEH,QAAQ;IAAED;EAAgB,CAAC,GAAG,MAAMJ,gCAAgC,CAC1ET,QACF,CAAC;EACD,MAAM8B,YAAY,GAAGR,CAAC,IAAI;IACxB;IACAS,OAAO,CAACC,KAAK,CAAC,4BAA4B,EAAEV,CAAC,CAACW,OAAO,CAAC;EACxD,CAAC;EACDnB,QAAQ,CAACO,EAAE,CAAC,OAAO,EAAES,YAAY,CAAC;EAClC,IAAI;IACF,OAAO,MAAMD,EAAE,CAACf,QAAQ,CAAC;EAC3B,CAAC,SAAS;IACRA,QAAQ,CAACoB,cAAc,CAAC,OAAO,EAAEJ,YAAY,CAAC;IAC9C,IAAI;MACF,MAAMjB,eAAe,CAAC,CAAC;IACzB,CAAC,CAAC,OAAOS,CAAC,EAAE;MACV;IAAA;EAEJ;AACF,CAAC;AAAC,IAAAa,QAAA,GAEaP,YAAY;AAAAD,OAAA,CAAAlC,OAAA,GAAA0C,QAAA"}